---
// è³¼ç‰©è»Šé é¢
// æª¢è¦–è³¼ç‰©è»Šå…§å®¹ã€çµå¸³

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="è³¼ç‰©è»Š">
  <Header />
  
  <main class="cart-page">
    <div class="container">
      <div class="page-header">
        <h1>ğŸ›’ è³¼ç‰©è»Š</h1>
        <a href="/order" class="continue-btn">â† ç¹¼çºŒé¸è³¼</a>
      </div>
      
      <div class="cart-layout">
        <!-- è³¼ç‰©è»Šé …ç›® -->
        <div class="cart-items" id="cartItems">
          <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
          <div class="empty-cart" id="emptyCart">
            <div class="empty-icon">ğŸ›’</div>
            <h2>è³¼ç‰©è»Šæ˜¯ç©ºçš„</h2>
            <p>å¿«å»æŒ‘é¸å–œæ­¡çš„è¨­è¨ˆé¢¨æ ¼å§ï¼</p>
            <a href="/order" class="btn btn-primary btn-lg">é–‹å§‹è¨­è¨ˆ â†’</a>
          </div>
        </div>
        
        <!-- çµå¸³å´é‚Šæ¬„ -->
        <aside class="checkout-sidebar" id="checkoutSidebar" style="display: none;">
          <div class="sidebar-card">
            <h3>è¨‚å–®æ‘˜è¦</h3>
            
            <!-- æœƒå“¡ç‹€æ…‹ -->
            <div class="member-status" id="memberStatus">
              <div class="member-badge guest">
                <span class="badge-icon">ğŸ‘¤</span>
                <span class="badge-text">è¨ªå®¢</span>
              </div>
              <a href="/member" class="login-link">ç™»å…¥äº«æœƒå“¡æŠ˜æ‰£ â†’</a>
            </div>
            
            <!-- åƒ¹æ ¼æ˜ç´° -->
            <div class="price-breakdown">
              <div class="price-row">
                <span>å°è¨ˆ</span>
                <span id="subtotalDisplay">NT$ 0</span>
              </div>
              <div class="price-row discount-row" id="discountRow" style="display: none;">
                <span>æœƒå“¡æŠ˜æ‰£ (<span id="discountLabel">95æŠ˜</span>)</span>
                <span class="discount-amount" id="discountAmount">-NT$ 0</span>
              </div>
              <div class="price-row total-row">
                <span>ç¸½è¨ˆ</span>
                <span class="total-price" id="totalDisplay">NT$ 0</span>
              </div>
            </div>
            
            <!-- çµå¸³æ–¹å¼ -->
            <div class="checkout-methods">
              <h4>é¸æ“‡ä»˜æ¬¾æ–¹å¼</h4>
              
              <!-- é¤˜é¡ä»˜æ¬¾ï¼ˆéœ€ç™»å…¥ï¼‰ -->
              <div class="method-option" id="balanceMethod" style="display: none;">
                <input type="radio" name="paymentMethod" value="balance" id="payBalance">
                <label for="payBalance">
                  <div class="method-info">
                    <span class="method-name">ğŸ’° é¤˜é¡ä»˜æ¬¾</span>
                    <span class="method-balance">é¤˜é¡ï¼šNT$ <span id="balanceAmount">0</span></span>
                  </div>
                </label>
              </div>
              
              <!-- éŠ€è¡ŒåŒ¯æ¬¾ -->
              <div class="method-option">
                <input type="radio" name="paymentMethod" value="bank_transfer" id="payBank" checked>
                <label for="payBank">
                  <div class="method-info">
                    <span class="method-name">ğŸ¦ éŠ€è¡ŒåŒ¯æ¬¾</span>
                    <span class="method-desc">åŒ¯æ¬¾å¾Œ LINE å‘ŠçŸ¥å³é–‹å§‹è£½ä½œ</span>
                  </div>
                </label>
              </div>
              
              <!-- å„²å€¼ä»˜æ¬¾ -->
              <div class="method-option highlight">
                <input type="radio" name="paymentMethod" value="deposit" id="payDeposit">
                <label for="payDeposit">
                  <div class="method-info">
                    <span class="method-name">â­ å„²å€¼ä»˜æ¬¾</span>
                    <span class="method-desc">å„²å€¼äº«æŠ˜æ‰£ï¼Œæœ€é«˜ 85 æŠ˜ï¼</span>
                  </div>
                  <span class="method-tag">æ¨è–¦</span>
                </label>
              </div>
            </div>
            
            <!-- çµå¸³æŒ‰éˆ• -->
            <button class="btn btn-primary btn-xl checkout-btn" id="checkoutBtn">
              ç¢ºèªçµå¸³
            </button>
            
            <!-- ä¿¡ä»»æ¨™èªŒ -->
            <div class="trust-info">
              <span>âœ… å®‰å…¨ä»˜æ¬¾</span>
              <span>ğŸ“¦ å¿«é€Ÿäº¤ä»¶</span>
              <span>ğŸ’¬ LINE å³æ™‚æœå‹™</span>
            </div>
          </div>
          
          <!-- å‡ç´šæç¤º -->
          <div class="upgrade-hint" id="upgradeHint" style="display: none;">
            <div class="hint-content">
              <span class="hint-icon">ğŸ’</span>
              <div>
                <p class="hint-title">å†å„²å€¼ <span id="upgradeAmount">$0</span></p>
                <p class="hint-desc">å³å¯å‡ç´š <span id="upgradeTier">éŠ€å¡</span> äº«æ›´å¤šæŠ˜æ‰£ï¼</p>
              </div>
            </div>
            <a href="/member/deposit" class="hint-link">ç«‹å³å„²å€¼ â†’</a>
          </div>
        </aside>
      </div>
    </div>
  </main>
  
  <!-- éŠ€è¡ŒåŒ¯æ¬¾ Modal -->
  <div class="modal-overlay" id="bankModal" style="display: none;">
    <div class="modal-content">
      <button class="modal-close" id="closeBankModal">âœ•</button>
      <div class="modal-icon">ğŸ¦</div>
      <h3 class="modal-title">éŠ€è¡ŒåŒ¯æ¬¾è³‡è¨Š</h3>
      
      <div class="bank-info">
        <div class="bank-row">
          <span class="bank-label">éŠ€è¡Œ</span>
          <span class="bank-value">åœ‹æ³°ä¸–è¯éŠ€è¡Œ (013)</span>
        </div>
        <div class="bank-row">
          <span class="bank-label">å¸³è™Ÿ</span>
          <span class="bank-value" id="bankAccountDisplay">000-00-000000-0</span>
          <button class="copy-btn" id="copyAccount">è¤‡è£½</button>
        </div>
        <div class="bank-row">
          <span class="bank-label">æˆ¶å</span>
          <span class="bank-value">æ·»å–œè¨­è¨ˆ</span>
        </div>
        <div class="bank-row highlight">
          <span class="bank-label">æ‡‰ä»˜é‡‘é¡</span>
          <span class="bank-value total" id="bankTotalDisplay">NT$ 0</span>
        </div>
      </div>
      
      <div class="bank-notice">
        <p>ğŸ“Œ åŒ¯æ¬¾å¾Œè«‹ä¿ç•™æ”¶æ“š</p>
        <p>ğŸ“Œ é€é LINE å‘ŠçŸ¥ã€Œå¸³è™Ÿæœ«äº”ç¢¼ã€+ã€Œè¨‚å–®ç·¨è™Ÿã€</p>
        <p>ğŸ“Œ ç¢ºèªæ”¶æ¬¾å¾Œç«‹å³é–‹å§‹è£½ä½œ</p>
      </div>
      
      <div class="order-created">
        <p>è¨‚å–®ç·¨è™Ÿ</p>
        <p class="order-number" id="orderNumber">-</p>
      </div>
      
      <a href="https://lin.ee/JQQdhG6" target="_blank" class="btn btn-line btn-lg">
        LINE å‘ŠçŸ¥åŒ¯æ¬¾
      </a>
    </div>
  </div>
  
  <!-- å„²å€¼å°å‘ Modal -->
  <div class="modal-overlay" id="depositModal" style="display: none;">
    <div class="modal-content">
      <button class="modal-close" id="closeDepositModal">âœ•</button>
      <div class="modal-icon">â­</div>
      <h3 class="modal-title">å„²å€¼äº«å„ªæƒ </h3>
      
      <div class="deposit-benefits">
        <div class="benefit-item">
          <span class="benefit-icon">ğŸ¥ˆ</span>
          <div>
            <span class="benefit-title">éŠ€å¡æœƒå“¡</span>
            <span class="benefit-desc">ç´¯è¨ˆå„²å€¼ $5,000 äº« 95 æŠ˜</span>
          </div>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">ğŸ¥‡</span>
          <div>
            <span class="benefit-title">é‡‘å¡æœƒå“¡</span>
            <span class="benefit-desc">ç´¯è¨ˆå„²å€¼ $30,000 äº« 9 æŠ˜</span>
          </div>
        </div>
        <div class="benefit-item">
          <span class="benefit-icon">ğŸ’</span>
          <div>
            <span class="benefit-title">ç™½é‡‘æœƒå“¡</span>
            <span class="benefit-desc">ç´¯è¨ˆå„²å€¼ $100,000 äº« 85 æŠ˜</span>
          </div>
        </div>
      </div>
      
      <div class="deposit-bonus">
        <p>ğŸ’° å„²å€¼å¾Œé¤˜é¡æ°¸ä¹…æœ‰æ•ˆï¼Œä¸æœƒéæœŸï¼</p>
      </div>
      
      <a href="/member/deposit" class="btn btn-primary btn-lg">
        å‰å¾€å„²å€¼é é¢ â†’
      </a>
      <button class="btn btn-ghost" id="skipDeposit">
        å…ˆç”¨åŒ¯æ¬¾çµå¸³
      </button>
    </div>
  </div>
</Layout>

<style>
  .cart-page {
    padding-top: calc(var(--header-height) + var(--space-8) + 4px);
    padding-bottom: var(--space-16);
    min-height: 100vh;
    background: var(--cream);
  }
  
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-8);
  }
  
  .page-header h1 {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 800;
    color: var(--gray-800);
  }
  
  .continue-btn {
    font-size: 14px;
    color: var(--gray-500);
    transition: color 0.2s;
  }
  
  .continue-btn:hover {
    color: var(--primary);
  }
  
  .cart-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: var(--space-8);
    align-items: start;
  }
  
  @media (max-width: 1024px) {
    .cart-layout {
      grid-template-columns: 1fr;
    }
  }
  
  /* ç©ºè³¼ç‰©è»Š */
  .empty-cart {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-16);
    text-align: center;
  }
  
  .empty-icon {
    font-size: 64px;
    margin-bottom: var(--space-4);
    opacity: 0.3;
  }
  
  .empty-cart h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: var(--space-2);
  }
  
  .empty-cart p {
    color: var(--gray-500);
    margin-bottom: var(--space-6);
  }
  
  /* è³¼ç‰©è»Šé …ç›® */
  .cart-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }
  
  .cart-item {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    display: flex;
    gap: var(--space-5);
    box-shadow: var(--shadow-sm);
  }
  
  .item-preview {
    width: 100px;
    height: 100px;
    background: var(--cream);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    flex-shrink: 0;
  }
  
  .item-details {
    flex: 1;
    min-width: 0;
  }
  
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-2);
  }
  
  .item-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--gray-800);
  }
  
  .item-style {
    font-size: 13px;
    color: var(--gray-500);
  }
  
  .item-brand {
    display: inline-block;
    padding: 4px 10px;
    background: var(--primary);
    color: white;
    border-radius: var(--radius-full);
    font-size: 12px;
    font-weight: 600;
    margin: var(--space-2) 0;
  }
  
  .item-plan {
    font-size: 13px;
    color: var(--teal);
    font-weight: 500;
  }
  
  .item-price {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-800);
    text-align: right;
  }
  
  .remove-btn {
    background: none;
    border: none;
    color: var(--gray-400);
    font-size: 12px;
    padding: var(--space-1) var(--space-2);
    cursor: pointer;
    transition: color 0.2s;
  }
  
  .remove-btn:hover {
    color: var(--accent);
  }
  
  /* çµå¸³å´é‚Šæ¬„ */
  .checkout-sidebar {
    position: sticky;
    top: calc(var(--header-height) + var(--space-8));
  }
  
  .sidebar-card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow);
  }
  
  .sidebar-card h3 {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: var(--space-5);
  }
  
  /* æœƒå“¡ç‹€æ…‹ */
  .member-status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--gray-100);
    border-radius: var(--radius);
    margin-bottom: var(--space-5);
  }
  
  .member-badge {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 14px;
    font-weight: 600;
  }
  
  .member-badge.guest {
    color: var(--gray-500);
  }
  
  .member-badge.silver {
    color: #6B7280;
  }
  
  .member-badge.gold {
    color: #F59E0B;
  }
  
  .member-badge.platinum {
    color: #8B5CF6;
  }
  
  .login-link {
    font-size: 12px;
    color: var(--teal);
  }
  
  /* åƒ¹æ ¼æ˜ç´° */
  .price-breakdown {
    padding: var(--space-4) 0;
    border-top: 1px solid var(--gray-200);
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: var(--space-5);
  }
  
  .price-row {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: var(--gray-600);
    margin-bottom: var(--space-2);
  }
  
  .price-row:last-child {
    margin-bottom: 0;
  }
  
  .discount-row .discount-amount {
    color: var(--teal);
  }
  
  .total-row {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-800);
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px dashed var(--gray-200);
  }
  
  .total-price {
    color: var(--primary);
  }
  
  /* ä»˜æ¬¾æ–¹å¼ */
  .checkout-methods {
    margin-bottom: var(--space-5);
  }
  
  .checkout-methods h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: var(--space-3);
  }
  
  .method-option {
    position: relative;
    margin-bottom: var(--space-2);
  }
  
  .method-option input {
    position: absolute;
    opacity: 0;
  }
  
  .method-option label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    background: var(--gray-50);
    border: 2px solid transparent;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .method-option input:checked + label {
    border-color: var(--primary);
    background: rgba(46, 59, 107, 0.05);
  }
  
  .method-option.highlight label {
    background: linear-gradient(135deg, rgba(255, 205, 86, 0.1) 0%, rgba(78, 205, 196, 0.1) 100%);
  }
  
  .method-option.highlight input:checked + label {
    border-color: var(--teal);
  }
  
  .method-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .method-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
  }
  
  .method-desc,
  .method-balance {
    font-size: 12px;
    color: var(--gray-500);
  }
  
  .method-tag {
    font-size: 11px;
    padding: 2px 8px;
    background: var(--teal);
    color: white;
    border-radius: var(--radius-full);
    font-weight: 600;
  }
  
  /* çµå¸³æŒ‰éˆ• */
  .checkout-btn {
    width: 100%;
    margin-bottom: var(--space-4);
  }
  
  .trust-info {
    display: flex;
    justify-content: center;
    gap: var(--space-4);
    font-size: 11px;
    color: var(--gray-400);
  }
  
  /* å‡ç´šæç¤º */
  .upgrade-hint {
    margin-top: var(--space-4);
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
  }
  
  .hint-content {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }
  
  .hint-icon {
    font-size: 24px;
  }
  
  .hint-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--gray-800);
  }
  
  .hint-desc {
    font-size: 12px;
    color: var(--gray-600);
  }
  
  .hint-link {
    display: block;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    color: var(--primary);
  }
  
  /* Modals */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-4);
  }
  
  .modal-content {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    max-width: 420px;
    width: 100%;
    position: relative;
    text-align: center;
  }
  
  .modal-close {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    background: none;
    border: none;
    font-size: 20px;
    color: var(--gray-400);
    cursor: pointer;
  }
  
  .modal-icon {
    font-size: 48px;
    margin-bottom: var(--space-4);
  }
  
  .modal-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: var(--space-5);
  }
  
  /* éŠ€è¡Œè³‡è¨Š */
  .bank-info {
    background: var(--gray-50);
    border-radius: var(--radius);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    text-align: left;
  }
  
  .bank-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--gray-200);
  }
  
  .bank-row:last-child {
    border-bottom: none;
  }
  
  .bank-row.highlight {
    background: rgba(78, 205, 196, 0.1);
    margin: var(--space-2) calc(var(--space-4) * -1);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius);
    border-bottom: none;
  }
  
  .bank-label {
    font-size: 13px;
    color: var(--gray-500);
    min-width: 60px;
  }
  
  .bank-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    flex: 1;
  }
  
  .bank-value.total {
    font-size: 18px;
    color: var(--primary);
  }
  
  .copy-btn {
    font-size: 11px;
    padding: 4px 10px;
    background: var(--gray-200);
    border: none;
    border-radius: var(--radius-full);
    color: var(--gray-600);
    cursor: pointer;
  }
  
  .copy-btn:hover {
    background: var(--gray-300);
  }
  
  .bank-notice {
    background: #FEF3C7;
    border-radius: var(--radius);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
    text-align: left;
  }
  
  .bank-notice p {
    font-size: 13px;
    color: var(--gray-700);
    margin-bottom: var(--space-1);
  }
  
  .bank-notice p:last-child {
    margin-bottom: 0;
  }
  
  .order-created {
    margin-bottom: var(--space-5);
  }
  
  .order-created p:first-child {
    font-size: 12px;
    color: var(--gray-500);
    margin-bottom: var(--space-1);
  }
  
  .order-number {
    font-family: var(--font-mono);
    font-size: 18px;
    font-weight: 700;
    color: var(--primary);
  }
  
  /* å„²å€¼å„ªæƒ  */
  .deposit-benefits {
    text-align: left;
    margin-bottom: var(--space-5);
  }
  
  .benefit-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--gray-50);
    border-radius: var(--radius);
    margin-bottom: var(--space-2);
  }
  
  .benefit-icon {
    font-size: 24px;
  }
  
  .benefit-title {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
  }
  
  .benefit-desc {
    display: block;
    font-size: 12px;
    color: var(--gray-500);
  }
  
  .deposit-bonus {
    background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
    border-radius: var(--radius);
    padding: var(--space-3);
    margin-bottom: var(--space-5);
  }
  
  .deposit-bonus p {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
  }
  
  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-full);
    font-weight: 600;
    font-size: 14px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-lg {
    padding: var(--space-4) var(--space-8);
    font-size: 15px;
    width: 100%;
  }
  
  .btn-xl {
    padding: var(--space-4) var(--space-8);
    font-size: 16px;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
  }
  
  .btn-line {
    background: var(--line-green);
    color: white;
  }
  
  .btn-ghost {
    background: transparent;
    color: var(--gray-500);
    margin-top: var(--space-2);
  }
  
  .btn-ghost:hover {
    color: var(--gray-700);
  }
</style>

<script>
  // è³¼ç‰©è»Šé é¢é‚è¼¯
  import { getCart, removeFromCart, getSubtotal, formatPrice, type CartItem } from '../lib/cart';
  import { getMember, memberTiers, getUpgradeAmount } from '../lib/member';
  
  // DOM å…ƒç´ 
  const cartItemsEl = document.getElementById('cartItems');
  const emptyCartEl = document.getElementById('emptyCart');
  const checkoutSidebar = document.getElementById('checkoutSidebar');
  const memberStatusEl = document.getElementById('memberStatus');
  const subtotalDisplay = document.getElementById('subtotalDisplay');
  const discountRow = document.getElementById('discountRow');
  const discountLabel = document.getElementById('discountLabel');
  const discountAmount = document.getElementById('discountAmount');
  const totalDisplay = document.getElementById('totalDisplay');
  const balanceMethod = document.getElementById('balanceMethod');
  const balanceAmount = document.getElementById('balanceAmount');
  const upgradeHint = document.getElementById('upgradeHint');
  const upgradeAmountEl = document.getElementById('upgradeAmount');
  const upgradeTierEl = document.getElementById('upgradeTier');
  const checkoutBtn = document.getElementById('checkoutBtn');
  
  // Modals
  const bankModal = document.getElementById('bankModal');
  const depositModal = document.getElementById('depositModal');
  const closeBankModal = document.getElementById('closeBankModal');
  const closeDepositModal = document.getElementById('closeDepositModal');
  const skipDeposit = document.getElementById('skipDeposit');
  const bankTotalDisplay = document.getElementById('bankTotalDisplay');
  const orderNumber = document.getElementById('orderNumber');
  const copyAccount = document.getElementById('copyAccount');
  
  // ç‹€æ…‹
  let currentMember = getMember();
  let discountRate = currentMember ? memberTiers[currentMember.tier].discountRate : 1;
  
  // æ¸²æŸ“è³¼ç‰©è»Š
  function renderCart() {
    const cart = getCart();
    
    if (cart.items.length === 0) {
      emptyCartEl!.style.display = 'block';
      checkoutSidebar!.style.display = 'none';
      return;
    }
    
    emptyCartEl!.style.display = 'none';
    checkoutSidebar!.style.display = 'block';
    
    // æ¸…é™¤èˆŠé …ç›®ï¼ˆä¿ç•™ç©ºè³¼ç‰©è»Šå…ƒç´ ï¼‰
    const existingItems = cartItemsEl!.querySelectorAll('.cart-item');
    existingItems.forEach(item => item.remove());
    
    // æ¸²æŸ“é …ç›®
    cart.items.forEach((item: CartItem) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'cart-item';
      itemEl.innerHTML = `
        <div class="item-preview">${getStyleEmoji(item.styleId)}</div>
        <div class="item-details">
          <div class="item-header">
            <div>
              <div class="item-name">${item.productName}</div>
              <div class="item-style">${item.styleName}</div>
            </div>
            <button class="remove-btn" data-id="${item.id}">ç§»é™¤</button>
          </div>
          <div class="item-brand">${item.brandName}</div>
          <div class="item-plan">${item.planName}</div>
        </div>
        <div class="item-price">NT$ ${formatPrice(item.price)}</div>
      `;
      
      cartItemsEl!.insertBefore(itemEl, emptyCartEl);
    });
    
    // ç¶å®šç§»é™¤æŒ‰éˆ•
    cartItemsEl!.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = (e.target as HTMLElement).dataset.id;
        if (id) {
          removeFromCart(id);
          renderCart();
        }
      });
    });
    
    // æ›´æ–°åƒ¹æ ¼
    updatePrices();
  }
  
  // å–å¾—é¢¨æ ¼ emojiï¼ˆæš«æ™‚ç”¨åˆ†é¡ï¼‰
  function getStyleEmoji(styleId: string): string {
    const emojiMap: Record<string, string> = {
      'food': 'ğŸ½ï¸',
      'elegant': 'ğŸ‘—',
      'minimal': 'ğŸ”·',
      'gaming': 'ğŸ®',
      'vtuber': 'ğŸ­',
      'badge': 'ğŸ…',
      'typo': 'âœï¸'
    };
    
    const category = styleId.split('-')[0];
    return emojiMap[category] || 'ğŸ¨';
  }
  
  // æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
  function updatePrices() {
    const subtotal = getSubtotal();
    const discount = subtotal * (1 - discountRate);
    const total = Math.round(subtotal * discountRate);
    
    subtotalDisplay!.textContent = `NT$ ${formatPrice(subtotal)}`;
    
    if (discountRate < 1) {
      discountRow!.style.display = 'flex';
      discountLabel!.textContent = memberTiers[currentMember!.tier].discountLabel;
      discountAmount!.textContent = `-NT$ ${formatPrice(Math.round(discount))}`;
    } else {
      discountRow!.style.display = 'none';
    }
    
    totalDisplay!.textContent = `NT$ ${formatPrice(total)}`;
  }
  
  // æ›´æ–°æœƒå“¡ç‹€æ…‹
  function updateMemberStatus() {
    currentMember = getMember();
    
    if (currentMember) {
      const tier = memberTiers[currentMember.tier];
      memberStatusEl!.innerHTML = `
        <div class="member-badge ${currentMember.tier}">
          <span class="badge-icon">${getTierIcon(currentMember.tier)}</span>
          <span class="badge-text">${tier.name}</span>
        </div>
        <span class="discount-info">${tier.discountLabel}</span>
      `;
      
      // é¡¯ç¤ºé¤˜é¡ä»˜æ¬¾é¸é …
      balanceMethod!.style.display = 'block';
      balanceAmount!.textContent = formatPrice(currentMember.balance);
      
      discountRate = tier.discountRate;
      
      // å‡ç´šæç¤º
      const upgradeInfo = getUpgradeAmount(currentMember.totalDeposit);
      if (upgradeInfo) {
        upgradeHint!.style.display = 'block';
        upgradeAmountEl!.textContent = `$${formatPrice(upgradeInfo.needed)}`;
        upgradeTierEl!.textContent = upgradeInfo.nextTier.name;
      }
    } else {
      discountRate = 1;
    }
    
    updatePrices();
  }
  
  function getTierIcon(tier: string): string {
    const icons: Record<string, string> = {
      basic: 'ğŸ‘¤',
      silver: 'ğŸ¥ˆ',
      gold: 'ğŸ¥‡',
      platinum: 'ğŸ’'
    };
    return icons[tier] || 'ğŸ‘¤';
  }
  
  // çµå¸³
  checkoutBtn?.addEventListener('click', () => {
    const method = (document.querySelector('input[name="paymentMethod"]:checked') as HTMLInputElement)?.value;
    
    if (method === 'deposit') {
      depositModal!.style.display = 'flex';
    } else if (method === 'balance') {
      // TODO: é¤˜é¡ä»˜æ¬¾é‚è¼¯
      alert('é¤˜é¡ä»˜æ¬¾åŠŸèƒ½é–‹ç™¼ä¸­');
    } else {
      // éŠ€è¡ŒåŒ¯æ¬¾
      showBankModal();
    }
  });
  
  // é¡¯ç¤ºéŠ€è¡ŒåŒ¯æ¬¾ Modal
  function showBankModal() {
    const total = Math.round(getSubtotal() * discountRate);
    bankTotalDisplay!.textContent = `NT$ ${formatPrice(total)}`;
    orderNumber!.textContent = generateOrderNumber();
    bankModal!.style.display = 'flex';
  }
  
  // ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
  function generateOrderNumber(): string {
    const now = new Date();
    const date = now.toISOString().slice(0, 10).replace(/-/g, '');
    const random = Math.random().toString(36).substr(2, 6).toUpperCase();
    return `TS${date}${random}`;
  }
  
  // Modal é—œé–‰
  closeBankModal?.addEventListener('click', () => {
    bankModal!.style.display = 'none';
  });
  
  closeDepositModal?.addEventListener('click', () => {
    depositModal!.style.display = 'none';
  });
  
  skipDeposit?.addEventListener('click', () => {
    depositModal!.style.display = 'none';
    showBankModal();
  });
  
  // è¤‡è£½å¸³è™Ÿ
  copyAccount?.addEventListener('click', () => {
    navigator.clipboard.writeText('000-00-000000-0');
    copyAccount.textContent = 'å·²è¤‡è£½ï¼';
    setTimeout(() => {
      copyAccount.textContent = 'è¤‡è£½';
    }, 2000);
  });
  
  // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal
  bankModal?.addEventListener('click', (e) => {
    if (e.target === bankModal) {
      bankModal.style.display = 'none';
    }
  });
  
  depositModal?.addEventListener('click', (e) => {
    if (e.target === depositModal) {
      depositModal.style.display = 'none';
    }
  });
  
  // ç›£è½è³¼ç‰©è»Šæ›´æ–°
  window.addEventListener('cart-updated', () => {
    renderCart();
  });
  
  // ç›£è½æœƒå“¡æ›´æ–°
  window.addEventListener('member-updated', () => {
    updateMemberStatus();
  });
  
  // åˆå§‹åŒ–
  renderCart();
  updateMemberStatus();
</script>
