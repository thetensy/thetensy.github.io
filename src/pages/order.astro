---
// ä¸‹å–®é é¢
// ä¸€é æå®šï¼šé¸é¢¨æ ¼ â†’ é¸æ–¹æ¡ˆ â†’ å¡«è³‡æ–™ â†’ åŠ å…¥è³¼ç‰©è»Š

import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import StyleCard from '../components/StyleCard.astro';
import PlanSelector from '../components/PlanSelector.astro';
import CartPanel from '../components/CartPanel.astro';

import { products, industries, colorOptions } from '../data/products';
import { logoStyles, styleCategories } from '../data/styles';

const logoProduct = products.logo;
---

<Layout title="ç·šä¸Šä¸‹å–®">
  <Header />
  
  <main class="main container">
    <div class="order-content">
      <!-- ç”¢å“é¡å‹é¸æ“‡ -->
      <section class="product-tabs card">
        {Object.entries(products).map(([key, product]) => (
          <button 
            class:list={['product-tab', { active: key === 'logo', disabled: !product.available }]}
            data-product={key}
            disabled={!product.available}
          >
            <span class="tab-emoji">{product.emoji}</span>
            <span class="tab-name">{product.name}</span>
            {product.comingSoon && <span class="coming-soon">å³å°‡æ¨å‡º</span>}
          </button>
        ))}
      </section>
      
      <!-- Step 1: é¸æ“‡é¢¨æ ¼ -->
      <section class="style-section card">
        <div class="section-header">
          <h2 class="section-title">
            <span class="step-number">1</span>
            é¸æ“‡è¨­è¨ˆé¢¨æ ¼
          </h2>
          <span class="style-count">å…± {logoStyles.length} ç¨®é¢¨æ ¼åƒè€ƒ</span>
        </div>
        
        <p class="section-desc">
          é€™äº›æ˜¯é¢¨æ ¼åƒè€ƒï¼Œè¨­è¨ˆå¸«æœƒæ ¹æ“šæ‚¨é¸æ“‡çš„æ–¹å‘é€²è¡ŒåŸå‰µè¨­è¨ˆ
        </p>
        
        <!-- é¢¨æ ¼åˆ†é¡ç¯©é¸ -->
        <div class="style-filters">
          <button class="filter-tag active" data-category="all">
            å…¨éƒ¨
          </button>
          {Object.entries(styleCategories).map(([key, cat]) => (
            <button class="filter-tag" data-category={key}>
              <span class="tag-emoji">{cat.emoji}</span>
              {cat.label}
            </button>
          ))}
        </div>
        
        <!-- é¢¨æ ¼ç¶²æ ¼ -->
        <div class="style-grid" id="styleGrid">
          {logoStyles.map((style, index) => (
            <StyleCard 
              id={style.id}
              name={style.name}
              categoryLabel={style.categoryLabel}
              description={style.description}
              reference={style.reference}
              emoji={style.emoji}
              selected={index === 0}
            />
          ))}
        </div>
      </section>
      
      <!-- Step 2: é¸æ“‡æ–¹æ¡ˆ -->
      <section class="plan-section card">
        <div class="section-header">
          <h2 class="section-title">
            <span class="step-number">2</span>
            é¸æ“‡æ–¹æ¡ˆ
          </h2>
        </div>
        
        <PlanSelector 
          plans={logoProduct.plans} 
          selectedPlan="basic"
          productName={logoProduct.name}
        />
      </section>
      
      <!-- Step 3: å¡«å¯«è³‡æ–™ -->
      <section class="form-section card">
        <div class="section-header">
          <h2 class="section-title">
            <span class="step-number">3</span>
            å¡«å¯«è¨­è¨ˆè³‡æ–™
          </h2>
        </div>
        
        <form class="order-form" id="orderForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">
                å“ç‰Œåç¨±
                <span class="required">*</span>
              </label>
              <input 
                type="text" 
                class="form-input" 
                id="brandName" 
                name="brandName"
                placeholder="ä¾‹å¦‚ï¼šBLOOM Coffeeã€èŠ±èªèŒ¶é¤¨"
                required
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">
                ç”¢æ¥­é¡å‹
                <span class="required">*</span>
              </label>
              <select class="form-select" id="industry" name="industry" required>
                <option value="">è«‹é¸æ“‡ç”¢æ¥­</option>
                {industries.map(ind => (
                  <option value={ind.value}>{ind.emoji} {ind.label}</option>
                ))}
              </select>
            </div>
            
            <div class="form-group full-width">
              <label class="form-label">ä¸»è‰²åå¥½</label>
              <div class="color-picker">
                {colorOptions.map((color, index) => (
                  <button 
                    type="button"
                    class:list={['color-option', { selected: index === 0 }]}
                    style={color.isGradient ? `background: ${color.hex}` : `background: ${color.hex}`}
                    data-color={color.id}
                    title={color.label}
                  >
                    <span class="sr-only">{color.label}</span>
                  </button>
                ))}
              </div>
            </div>
            
            <div class="form-group full-width">
              <label class="form-label">å‚™è¨»èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
              <textarea 
                class="form-textarea" 
                id="notes" 
                name="notes"
                placeholder="ä»»ä½•æƒ³å‘Šè¨´è¨­è¨ˆå¸«çš„è©±ï¼Œä¾‹å¦‚ï¼šå¸Œæœ›æœ‰æ‰‹å¯«æ„Ÿã€è¦æ”¾è‹±æ–‡å‰¯æ¨™é¡Œã€åå¥½ç°¡ç´„é¢¨æ ¼..."
              ></textarea>
            </div>
          </div>
        </form>
      </section>
    </div>
    
    <!-- å³å´è³¼ç‰©è»Š -->
    <CartPanel />
  </main>
  
  <!-- Floating LINE Button (Mobile) -->
  <a href="https://lin.ee/JQQdhG6" target="_blank" class="float-line">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
      <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.193 0-.378-.104-.481-.281l-2.432-3.308v2.962c0 .349-.282.63-.63.63-.345 0-.627-.281-.627-.63V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.478.281l2.439 3.308V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-5.741 0c0 .349-.282.63-.631.63-.345 0-.627-.281-.627-.63V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.63H4.917c-.345 0-.63-.281-.63-.63V8.108c0-.345.285-.63.63-.63.349 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
    </svg>
  </a>
</Layout>

<style>
  .main {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: var(--space-8);
    padding-top: calc(var(--header-height) + var(--space-8) + 4px);
    padding-bottom: var(--space-12);
  }
  
  @media (max-width: 1024px) {
    .main {
      grid-template-columns: 1fr;
      padding-bottom: 180px; /* çµ¦åº•éƒ¨è³¼ç‰©è»Šç•™ç©ºé–“ */
    }
  }
  
  @media (max-width: 640px) {
    .main {
      padding-left: var(--space-4);
      padding-right: var(--space-4);
    }
  }
  
  .order-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }
  
  .card {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    box-shadow: var(--shadow);
  }
  
  @media (max-width: 640px) {
    .card {
      padding: var(--space-4);
      border-radius: var(--radius);
    }
  }
  
  /* Product Tabs */
  .product-tabs {
    display: flex;
    gap: var(--space-2);
    padding: var(--space-2);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  
  .product-tabs::-webkit-scrollbar {
    display: none;
  }
  
  .product-tab {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    background: transparent;
    border: none;
    border-radius: var(--radius);
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-500);
    white-space: nowrap;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  
  @media (max-width: 640px) {
    .product-tab {
      padding: var(--space-2) var(--space-4);
      font-size: 13px;
    }
    
    .product-tab .tab-name {
      display: none;
    }
  }
  
  .product-tab:not(:disabled):hover {
    background: var(--gray-100);
    color: var(--gray-700);
  }
  
  .product-tab.active {
    background: var(--primary);
    color: white;
  }
  
  .product-tab:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .tab-emoji {
    font-size: 18px;
  }
  
  .coming-soon {
    font-size: 10px;
    padding: 2px 6px;
    background: var(--gray-200);
    border-radius: var(--radius-full);
    color: var(--gray-500);
  }
  
  /* Section Header */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
    gap: var(--space-2);
  }
  
  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-800);
  }
  
  @media (max-width: 640px) {
    .section-title {
      font-size: 16px;
    }
  }
  
  .step-number {
    width: 28px;
    height: 28px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
  }
  
  .style-count {
    font-size: 13px;
    color: var(--gray-400);
  }
  
  .section-desc {
    font-size: 14px;
    color: var(--gray-500);
    margin-bottom: var(--space-5);
    padding-left: calc(28px + var(--space-3));
  }
  
  /* Style Filters */
  .style-filters {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    margin-bottom: var(--space-5);
  }
  
  .filter-tag {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-4);
    background: var(--gray-100);
    border: none;
    border-radius: var(--radius-full);
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .filter-tag:hover {
    background: var(--gray-200);
  }
  
  .filter-tag.active {
    background: var(--teal);
    color: white;
  }
  
  .tag-emoji {
    font-size: 14px;
  }
  
  /* Style Grid */
  .style-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-4);
  }
  
  @media (min-width: 768px) {
    .style-grid {
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
  }
  
  /* Plan Section */
  .plan-section {
    /* PlanSelector çµ„ä»¶è‡ªå¸¶æ¨£å¼ */
  }
  
  /* Form Section */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-5);
  }
  
  @media (max-width: 640px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  /* Color Picker */
  .color-picker {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
  }
  
  .color-option {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
  }
  
  .color-option:hover {
    transform: scale(1.1);
  }
  
  .color-option.selected {
    border-color: var(--gray-800);
    box-shadow: 0 0 0 2px var(--white), 0 0 0 4px var(--gray-800);
  }
  
  /* Float LINE Button */
  .float-line {
    display: none;
    position: fixed;
    bottom: 180px;
    right: var(--space-4);
    width: 56px;
    height: 56px;
    background: var(--line-green);
    color: white;
    border-radius: 50%;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    z-index: 80;
    transition: transform 0.2s ease;
  }
  
  .float-line:hover {
    transform: scale(1.05);
  }
  
  @media (max-width: 1024px) {
    .float-line {
      display: flex;
    }
  }
</style>

<script>
  // ===== äº’å‹•é‚è¼¯ =====
  
  // é¢¨æ ¼é¸æ“‡
  const styleCards = document.querySelectorAll('.style-card');
  styleCards.forEach(card => {
    card.addEventListener('click', function() {
      styleCards.forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      
      const styleName = this.dataset.styleName;
      const styleCategory = this.dataset.styleCategory;
      
      // æ›´æ–°è³¼ç‰©è»Šé¡¯ç¤º
      const styleNameEl = document.getElementById('currentStyleName');
      if (styleNameEl) {
        styleNameEl.textContent = `${styleName} Â· ${styleCategory}`;
      }
    });
  });
  
  // é¢¨æ ¼ç¯©é¸
  const filterTags = document.querySelectorAll('.filter-tag');
  filterTags.forEach(tag => {
    tag.addEventListener('click', function() {
      filterTags.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const category = this.dataset.category;
      
      styleCards.forEach(card => {
        const cardCategory = card.dataset.styleCategory;
        if (category === 'all') {
          (card as HTMLElement).style.display = '';
        } else {
          // ç°¡å–®çš„åˆ†é¡å°æ‡‰ï¼ˆå¯¦éš›æ‡‰è©²ç”¨æ›´å¥½çš„æ–¹å¼ï¼‰
          const categoryMap: Record<string, string> = {
            'food': 'é¤é£²ç¾é£Ÿ',
            'elegant': 'å„ªé›…è³ªæ„Ÿ',
            'tech': 'ç§‘æŠ€ç¾ä»£',
            'retro': 'å¾©å¤æ‡·èˆŠ',
            'minimal': 'æ¥µç°¡é¢¨æ ¼',
            'natural': 'è‡ªç„¶æœ‰æ©Ÿ',
            'playful': 'æ´»æ½‘å¯æ„›'
          };
          const show = cardCategory === categoryMap[category];
          (card as HTMLElement).style.display = show ? '' : 'none';
        }
      });
    });
  });
  
  // æ–¹æ¡ˆé¸æ“‡
  const planInputs = document.querySelectorAll('input[name="plan"]');
  planInputs.forEach(input => {
    input.addEventListener('change', function(this: HTMLInputElement) {
      const label = this.closest('.plan-option');
      document.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('selected'));
      label?.classList.add('selected');
      
      // æ›´æ–°è³¼ç‰©è»Š
      const price = this.dataset.price;
      const days = this.dataset.days;
      const revisions = this.dataset.revisions;
      const formats = this.dataset.formats;
      const planName = this.value === 'basic' ? 'åŸºç¤ç‰ˆ' : 'å°ˆæ¥­ç‰ˆ';
      
      updateCart({
        plan: planName,
        price: Number(price),
        days: Number(days),
        revisions: Number(revisions),
        formats: formats || ''
      });
    });
  });
  
  // é¡è‰²é¸æ“‡
  const colorOptions = document.querySelectorAll('.color-option');
  colorOptions.forEach(option => {
    option.addEventListener('click', function() {
      colorOptions.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
    });
  });
  
  // æ›´æ–°è³¼ç‰©è»Šå‡½æ•¸
  function updateCart(data: { plan: string; price: number; days: number; revisions: number; formats: string }) {
    const planEl = document.getElementById('currentPlan');
    const priceEl = document.getElementById('currentPrice');
    const daysEl = document.getElementById('currentDays');
    const revisionsEl = document.getElementById('currentRevisions');
    const formatsEl = document.getElementById('currentFormats');
    const totalEl = document.getElementById('totalAmount');
    
    if (planEl) planEl.textContent = data.plan;
    if (priceEl) priceEl.textContent = `NT$ ${data.price.toLocaleString()}`;
    if (daysEl) daysEl.textContent = `${data.days} å€‹å·¥ä½œå¤©`;
    if (revisionsEl) revisionsEl.textContent = `${data.revisions} æ¬¡`;
    if (formatsEl) formatsEl.textContent = data.formats;
    if (totalEl) totalEl.textContent = data.price.toLocaleString();
  }
  
  // åŠ å…¥è³¼ç‰©è»Š
  const addToCartBtn = document.getElementById('addToCartBtn');
  addToCartBtn?.addEventListener('click', () => {
    const brandName = (document.getElementById('brandName') as HTMLInputElement)?.value;
    const industry = (document.getElementById('industry') as HTMLSelectElement)?.value;
    
    if (!brandName) {
      alert('è«‹å¡«å¯«å“ç‰Œåç¨±ï¼');
      document.getElementById('brandName')?.focus();
      return;
    }
    
    if (!industry) {
      alert('è«‹é¸æ“‡ç”¢æ¥­é¡å‹ï¼');
      document.getElementById('industry')?.focus();
      return;
    }
    
    // TODO: å¯¦ä½œè³¼ç‰©è»Šé‚è¼¯
    alert('âœ… å·²åŠ å…¥è³¼ç‰©è»Šï¼\n\nï¼ˆè³¼ç‰©è»ŠåŠŸèƒ½é–‹ç™¼ä¸­ï¼Œç›®å‰è«‹é€é LINE å®Œæˆè¨‚è³¼ï¼‰');
  });
  
  // ä¸‹è¼‰å ±åƒ¹å–®
  const downloadBtn = document.getElementById('downloadQuoteBtn');
  downloadBtn?.addEventListener('click', () => {
    alert('ğŸ“„ å ±åƒ¹å–®ä¸‹è¼‰åŠŸèƒ½é–‹ç™¼ä¸­ï¼\n\nå…§å®¹å°‡åŒ…å«ï¼š\n- é¸æ“‡çš„é¢¨æ ¼èˆ‡æ–¹æ¡ˆ\n- å“ç‰Œåç¨±èˆ‡éœ€æ±‚\n- åƒ¹æ ¼èˆ‡äº¤æœŸ');
  });
</script>
